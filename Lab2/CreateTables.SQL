CREATE TABLE catalog_nodes (
    catalog_node_id INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    parent_node_id  INT REFERENCES catalog_nodes (catalog_node_id),
    title           varchar(64)
);

CREATE TABLE products (
    product_id          INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    catalog_node_id     INT REFERENCES catalog_nodes (catalog_node_id),
    is_delivery_enabled BOOLEAN DEFAULT false,
    is_pickup_enabled   BOOLEAN DEFAULT false,
    title               varchar(64),
    description         varchar(1024)
);

CREATE TABLE product_price (
    price_id        INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    prodict_id      INT REFERENCES products (product_id),
    old_price       INT,
    current_price   INT NOT NULL,
    date            DATE NOT NULL,
    version         INT NOT NULL DEFAULT 1
);

CREATE TABLE tags (
    tag_id  INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    title   varchar(32),
    color   varchar(16)
);

CREATE TABLE tags_products (
    product_id  INT REFERENCES products (product_id),
    tag_id      INT REFERENCES tags     (tag_id),
    CONSTRAINT tags_products_pkey PRIMARY KEY (product_id, tag_id) -- explicit pk
);

CREATE TABLE rates (
    rate_id     INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    gigabytes   INT NOT NULL,
    minutes     INT NOT NULL,
    sms         INT NOT NULL,
    end_at      DATE
);

CREATE TABLE price_units (
    price_unit_id   INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    one_gigabyte    FLOAT NOT NULL,
    koef_gigabyte   FLOAT NOT NULL,
    one_minutes     FLOAT NOT NULL,
    koef_minutes    FLOAT NOT NULL,
    one_sms         FLOAT NOT NULL,
    koef_sms        FLOAT NOT NULL,
    created_date    DATE NOT NULL DEFAULT current_date
);

CREATE TABLE rates_price_units (
    rate_id         INT REFERENCES rates (rate_id),
    price_unit_id   INT REFERENCES price_units (price_unit_id),
    rate_price      FLOAT,
    CONSTRAINT rate_price_unit_pkey PRIMARY KEY (rate_id, price_unit_id) -- explicit pk
);


DROP TABLE product_price;
DROP TABLE tags_products;
DROP TABLE products;
